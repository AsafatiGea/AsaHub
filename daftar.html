<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar - AsaHub</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <!-- Local JS -->
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-service.js"></script>
    <!-- CSS Modular -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/role-selection.css">
    <link rel="stylesheet" href="css/responsive-mobile.css">
    <link rel="stylesheet" href="css/responsive-desktop.css">
</head>
<body>

<div class="auth-container">
    <div class="auth-card fade-in" style="max-width: 600px;">
        <div class="auth-header">
            <a href="index.html" class="auth-logo">Asa<span>Hub</span></a>
            <h1 class="auth-title">Bergabung dengan AsaHub</h1>
            <p class="auth-subtitle">Pilih peran Anda dan mulai berjualan atau berbelanja</p>
        </div>

        <div class="auth-message error" id="alertError"></div>
        <div class="auth-message success" id="alertSuccess">Akun berhasil dibuat! Mengarahkan ke login...</div>

        <!-- Role Selection -->
        <div class="role-selection" id="roleSelection">
            <h3 class="role-title">Pilih Jenis Akun:</h3>
            <div class="role-options">
                <div class="role-card" data-role="buyer" onclick="selectRole('buyer')">
                    <div class="role-icon">üõí</div>
                    <h4>Pembeli</h4>
                    <p>Belanja produk dari berbagai seller</p>
                    <ul class="role-features">
                        <li>‚úÖ Akses ke semua produk</li>
                        <li>‚úÖ Keranjang belanja</li>
                        <li>‚úÖ Tracking pesanan</li>
                        <li>‚úÖ Tidak ada persyaratan khusus</li>
                    </ul>
                </div>
                
                <div class="role-card" data-role="seller" onclick="selectRole('seller')">
                    <div class="role-icon">üè™</div>
                    <h4>Penjual</h4>
                    <p>Jual produk Anda ke ribuan pembeli</p>
                    <ul class="role-features">
                        <li>‚úÖ Dashboard lengkap</li>
                        <li>‚úÖ Manajemen produk</li>
                        <li>‚úÖ Analytics penjualan</li>
                        <li>‚ö†Ô∏è Perlu verifikasi data</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Registration Form (Hidden Initially) -->
        <form class="auth-form" id="registrationForm" style="display: none;" onsubmit="doRegister(event)">
            <input type="hidden" id="selectedRole" name="role" required>
            
            <div class="form-group">
                <label class="form-label">Nama Lengkap <span class="required">*</span></label>
                <input type="text" class="form-input" id="name" placeholder="Nama lengkap sesuai KTP" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" class="form-input" id="email" placeholder="nama@email.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">No. Telepon / WhatsApp <span class="required">*</span></label>
                <input type="tel" class="form-input" id="phone" placeholder="0812-xxxx-xxxx" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password <span class="required">*</span></label>
                <div class="password-input">
                    <input type="password" class="form-input" id="password" placeholder="Minimal 6 karakter" required minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePassword('password')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Konfirmasi Password <span class="required">*</span></label>
                <div class="password-input">
                    <input type="password" class="form-input" id="confirmPassword" placeholder="Ulangi password" required minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <!-- Seller Specific Fields (Hidden for Buyer) -->
            <div id="sellerFields" style="display: none;">
                <div class="seller-notice">
                    <h4>üìã Persyaratan Menjadi Seller</h4>
                    <p>Setelah registrasi, Anda akan diminta untuk melengkapi data verifikasi:</p>
                    <ul>
                        <li>üìå Data Diri (KTP, foto selfie)</li>
                        <li>üè™ Profil Toko (nama, logo, kategori)</li>
                        <li>üí≥ Rekening Pembayaran</li>
                        <li>‚úÖ Komitmen Seller (terms & conditions)</li>
                    </ul>
                </div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="terms" required>
                    <span class="checkmark"></span>
                    Saya menyetujui <a href="#" class="link">Syarat & Ketentuan</a> dan <a href="#" class="link">Kebijakan Privasi</a> AsaHub
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                <i class="fas fa-user-plus"></i>
                <span id="submitText">Daftar Sekarang</span>
            </button>
            
            <div class="auth-footer">
                <p>Sudah punya akun? <a href="login.html" class="link">Masuk di sini</a></p>
            </div>
        </form>
    </div>
</div>
                <label class="form-label">Daftar sebagai</label>
                <select class="form-input" id="role">
                    <option value="pembeli">Pembeli</option>
                    <option value="penjual">Penjual / Merchant</option>
                    <option value="penyedia_jasa">Penyedia Jasa</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-input-wrapper">
                    <input type="password" class="form-input" id="password" placeholder="Min. 6 karakter" required>
                    <button type="button" class="password-toggle" onclick="togglePassword()">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Konfirmasi Password</label>
                <div class="password-input-wrapper">
                    <input type="password" class="form-input" id="confirm" placeholder="Ulangi password" required>
                    <button type="button" class="password-toggle" onclick="toggleConfirmPassword()">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="form-options">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="terms" required>
                    <label for="terms">Saya setuju dengan <a href="tentang.html" style="color: var(--primary);">Syarat & Ketentuan</a></label>
                </div>
            </div>

            <button type="submit" class="auth-button primary">
                <span id="registerText">Buat Akun</span>
                <div class="auth-loading" id="registerLoading" style="display: none;"></div>
            </button>
        </form>

        <div class="auth-divider">
            <span>atau</span>
        </div>

        <div class="social-login">
            <a href="#" class="social-button google">
                <i class="fab fa-google"></i>
                Daftar dengan Google
            </a>
            <a href="#" class="social-button facebook">
                <i class="fab fa-facebook-f"></i>
                Daftar dengan Facebook
            </a>
        </div>

        <div class="auth-footer">
            <p>Sudah punya akun? <a href="login.html">Masuk di sini</a></p>
            <p><a href="index.html">‚Üê Kembali ke Marketplace</a></p>
        </div>
    </div>
</div>

<script>
// Role Selection Functions
function selectRole(role) {
    // Update UI
    document.querySelectorAll('.role-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-role="${role}"]`).classList.add('selected');
    
    // Show registration form
    document.getElementById('roleSelection').style.display = 'none';
    document.getElementById('registrationForm').style.display = 'block';
    document.getElementById('selectedRole').value = role;
    
    // Show seller fields if seller is selected
    const sellerFields = document.getElementById('sellerFields');
    const submitText = document.getElementById('submitText');
    
    if (role === 'seller') {
        sellerFields.style.display = 'block';
        submitText.textContent = 'Daftar sebagai Seller';
    } else {
        sellerFields.style.display = 'none';
        submitText.textContent = 'Daftar sebagai Pembeli';
    }
    
    // Scroll to form
    document.getElementById('registrationForm').scrollIntoView({ behavior: 'smooth' });
}

// Password Toggle Functions
function togglePassword(fieldId) {
    const passwordInput = document.getElementById(fieldId);
    const toggleBtn = passwordInput.nextElementSibling;
    const toggleIcon = toggleBtn.querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

// Enhanced Registration Function
async function doRegister(event) {
    event.preventDefault();
    
    // Check if authService is available
    if (!window.authService) {
        console.error('AuthService not loaded');
        showError('System error. Please refresh the page.');
        return;
    }
    
    // Get form values
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const role = document.getElementById('selectedRole').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const terms = document.getElementById('terms').checked;
    
    // Validation
    if (!name || !email || !phone || !password || !confirmPassword) {
        showError('Semua field wajib diisi!');
        return;
    }
    
    if (password !== confirmPassword) {
        showError('Password dan konfirmasi password tidak cocok!');
        return;
    }
    
    if (password.length < 6) {
        showError('Password minimal 6 karakter!');
        return;
    }
    
    if (!terms) {
        showError('Anda harus menyetujui syarat & ketentuan!');
        return;
    }
    
    if (!role) {
        showError('Silakan pilih jenis akun terlebih dahulu!');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
        // Prepare user data
        const userData = {
            email: email,
            password: password,
            role: role,
            full_name: name,
            phone: phone
        };
        
        console.log('Registering user:', userData);
        
        // Call authService register
        const result = await authService.register(userData);
        
        if (result.success) {
            showSuccess('Akun berhasil dibuat! Mengarahkan ke dashboard...');
            
            // Redirect based on role after delay
            setTimeout(() => {
                if (role === 'seller') {
                    // Redirect to seller verification page
                    window.location.href = 'seller-verification.html';
                } else {
                    // Redirect to buyer dashboard
                    window.location.href = 'buyer-dashboard.html';
                }
            }, 2000);
        } else {
            showError(result.error || 'Registrasi gagal. Silakan coba lagi.');
        }
    } catch (error) {
        console.error('Registration error:', error);
        showError('Terjadi kesalahan. Silakan coba lagi.');
    } finally {
        // Reset button state
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Helper Functions
function showError(message) {
    const errorEl = document.getElementById('alertError');
    const successEl = document.getElementById('alertSuccess');
    
    errorEl.textContent = message;
    errorEl.classList.add('show');
    successEl.classList.remove('show');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        errorEl.classList.remove('show');
    }, 5000);
}

function showSuccess(message) {
    const errorEl = document.getElementById('alertError');
    const successEl = document.getElementById('alertSuccess');
    
    successEl.textContent = message;
    successEl.classList.add('show');
    errorEl.classList.remove('show');
}

// Email validation on input
document.getElementById('email').addEventListener('input', function(e) {
    const email = e.target.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        e.target.setCustomValidity('Format email tidak valid');
    } else {
        e.target.setCustomValidity('');
    }
});

// Phone validation on input
document.getElementById('phone').addEventListener('input', function(e) {
    const phone = e.target.value;
    const phoneRegex = /^[0-9+\-\s()]+$/;
    
    if (phone && !phoneRegex.test(phone)) {
        e.target.setCustomValidity('Nomor telepon hanya boleh angka');
    } else {
        e.target.setCustomValidity('');
    }
});

// Password strength indicator
document.getElementById('password').addEventListener('input', function(e) {
    const password = e.target.value;
    let strength = 0;
    
    if (password.length >= 6) strength++;
    if (password.length >= 10) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    
    // You can add password strength indicator UI here if needed
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Registration page loaded');
    
    // Check if user is already logged in
    if (window.authService && window.authService.isAuthenticated()) {
        const user = window.authService.getCurrentUser();
        if (user) {
            // Redirect to appropriate dashboard
            if (user.role === 'seller') {
                window.location.href = 'seller-dashboard.html';
            } else if (user.role === 'admin') {
                window.location.href = 'admin-dashboard.html';
            } else {
                window.location.href = 'buyer-dashboard.html';
            }
            return;
        }
    }
});
</script>
    const errEl = document.getElementById('alertError');
    const okEl = document.getElementById('alertSuccess');

    // Reset messages
    errEl.classList.remove('show');
    okEl.classList.remove('show');

    // Validation
    if (!name || !email || !phone || !password) {
        errEl.textContent = 'Semua kolom harus diisi.';
        errEl.classList.add('show');
        return;
    }
    
    if (password.length < 6) {
        errEl.textContent = 'Password minimal 6 karakter.';
        errEl.classList.add('show');
        return;
    }
    
    if (password !== confirm) {
        errEl.textContent = 'Password tidak cocok.';
        errEl.classList.add('show');
        return;
    }
    
    if (!terms) {
        errEl.textContent = 'Anda harus menyetujui Syarat & Ketentuan.';
        errEl.classList.add('show');
        return;
    }

    // Show loading
    registerText.style.display = 'none';
    registerLoading.style.display = 'inline-block';

    // Call actual registration API
    try {
        const result = await window.authService.register({
            fullName: name,
            email: email,
            phone: phone,
            role: role,
            password: password
        });
        
        if (result.success) {
            okEl.classList.add('show');
            setTimeout(() => { 
                window.location.href = 'login.html'; 
            }, 1500);
        } else {
            errEl.textContent = result.error || 'Registrasi gagal. Silakan coba lagi.';
            errEl.classList.add('show');
            
            // Reset loading
            registerText.style.display = 'inline';
            registerLoading.style.display = 'none';
            
            // Shake animation
            document.querySelector('.auth-card').style.animation = 'shake 0.5s';
            setTimeout(() => {
                document.querySelector('.auth-card').style.animation = '';
            }, 500);
        }
    } catch (error) {
        console.error('Registration error:', error);
        errEl.textContent = 'Terjadi kesalahan. Silakan coba lagi.';
        errEl.classList.add('show');
        
        // Reset loading
        registerText.style.display = 'inline';
        registerLoading.style.display = 'none';
        
        // Shake animation
        document.querySelector('.auth-card').style.animation = 'shake 0.5s';
        setTimeout(() => {
            document.querySelector('.auth-card').style.animation = '';
        }, 500);
    }
}

// Add shake animation
const style = document.createElement('style');
style.textContent = `
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}
`;
document.head.appendChild(style);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Focus on name input
    document.getElementById('name').focus();
});
</script>
</body>
</html>
